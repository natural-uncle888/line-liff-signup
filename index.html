<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ç»æ–¯èŠç­æ´»å‹•å ±åç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="./styles.css" rel="stylesheet">
</head>
<body>

<div id="loadingOverlay" style="display:none; position:fixed; inset:0; z-index:2000; background:rgba(255,255,255,.75); backdrop-filter: blur(3px);">
  <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center;">
    <div class="card shadow-sm" style="max-width:360px; width:92%;">
      <div class="card-body d-flex align-items-center gap-3">
        <div class="spinner-border" role="status" aria-label="loading"></div>
        <div>
          <div class="fw-semibold" id="loadingText">è¼‰å…¥ä¸­â€¦</div>
          <div class="small-muted">è³‡æ–™é‡è¼ƒå¤§æ™‚å¯èƒ½éœ€è¦å¹¾ç§’é˜</div>
        </div>
      </div>
    </div>
  </div>
</div>

<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand" href="./index.html">ğŸ“Œ æ´»å‹•å ±å</a>
    <div class="ms-auto d-flex align-items-center gap-2">
      <div id="userPill"></div>
      <a class="btn btn-sm btn-outline-secondary" href="./admin.html">ç®¡ç†</a>
    </div>
  </div>
</nav>

<div class="container py-3">
  <div id="toast" class="alert alert-info" style="display:none"></div>

  <div class="row g-3 align-items-start">
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-2">æ´»å‹•åˆ—è¡¨</h5>
          <div class="small-muted mb-3">é¸ä¸€å€‹æ´»å‹•é–‹å§‹å ±åï¼ˆå¯é¸æ®µè½ï¼‰</div>
          <div id="eventsList" class="list-group"></div>
          <div class="small-muted mt-3">æç¤ºï¼šåœ¨ LINE å…§é–‹å•Ÿæœƒè‡ªå‹•å¸¶å…¥å§“åä¸¦é¡¯ç¤ºåå–®ï¼ˆæ›´æœ‰ã€Œè·Ÿé¢¨ã€æ•ˆæœï¼‰ã€‚</div>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between gap-3">
            <div>
              <h4 class="card-title mb-1" id="eventTitle">è«‹å…ˆé¸æ“‡æ´»å‹•</h4>
              <div class="small-muted" id="eventDesc"></div>
            </div>
            <div class="text-end">
              <button class="btn btn-sm btn-outline-primary d-none" id="btnShare" disabled>åœ¨ LINE åˆ†äº«æ­¤æ´»å‹•</button>
            </div>
          </div>

          <div id="eventStatus" class="mt-3"></div>

          <div class="row g-2 mt-2">
            <div class="col-md-6">
              <div class="kpi p-3">
                <div class="small-muted">ä½ é€™æ¬¡è¦å ±åçš„äººæ•¸</div>
                <div class="row g-2 mt-1">
                  <div class="col-6">
                    <label class="form-label mb-1">å¹¾å¤§</label>
                    <input id="adults" type="number" min="0" max="20" class="form-control" placeholder="ä¾‹å¦‚ 2">
                  </div>
                  <div class="col-6">
                    <label class="form-label mb-1">å¹¾å°</label>
                    <input id="kids" type="number" min="0" max="20" class="form-control" placeholder="ä¾‹å¦‚ 1">
                  </div>
                </div>
                <div class="form-text">åªå½±éŸ¿ä½ é€™ç­†å ±åçš„çµ±è¨ˆèˆ‡é¡¯ç¤ºã€‚</div>

                <div class="row g-2 mt-2">
                  <div class="col-12">
                    <label class="form-label mb-1">å°æœ‹å‹åå­—ï¼ˆå¯å¡«å¤šä½ï¼Œç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
                    <input id="childName" type="text" class="form-control" placeholder="ä¾‹å¦‚ï¼šå°æ˜ã€å°ç¾">
                    <div class="form-text">è®“å¤§å®¶æ›´å®¹æ˜“çŸ¥é“æ˜¯å“ªä½å®¶é•·å ±åã€‚</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="kpi p-3 h-100 d-flex flex-column justify-content-between">
                <div>
                  <div class="small-muted">å¿«é€Ÿæ“ä½œ</div>
                  <div class="d-flex flex-wrap gap-2 mt-2">
                    <button class="btn btn-success" id="btnAll" disabled>âœ… å…¨ç¨‹åƒåŠ </button>
                    <button class="btn btn-outline-secondary" id="btnNone" disabled>â†©ï¸ å–æ¶ˆå…¨ç¨‹</button>
                    <button class="btn btn-primary" id="btnSubmit" disabled>é€å‡º / æ›´æ–°å ±å</button>
                  </div>
                </div>
                <div class="small-muted mt-2">çµå–®å¾Œä»å¯æŸ¥çœ‹åå–®ï¼Œä½†ä¸èƒ½å†æ›´æ–°å ±åã€‚</div>
              </div>
            </div>
          </div>

          <hr class="my-4"/>

          <h6 class="mb-2">è¡Œç¨‹æ¸…å–®ï¼ˆå¯é¸åƒåŠ ï¼‰</h6>
          <div id="segmentsWrap" class="vstack gap-2"></div>

          <hr class="my-4"/>

          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
              <h6 class="mb-0">ç›®å‰åƒåŠ ç‹€æ³</h6>
              <span id="regsSpinner" class="spinner-border spinner-border-sm text-secondary" role="status" aria-label="loading" style="display:none"></span>
            </div>
            <button class="btn btn-sm btn-outline-secondary" id="btnRefresh" disabled>é‡æ–°æ•´ç†</button>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-4">
              <div class="kpi p-3">
                <div class="small-muted">çµ„æ•¸ï¼ˆè‡³å°‘ä¸€æ®µï¼‰</div>
                <div class="value" id="totalGroups">â€”</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="kpi p-3">
                <div class="small-muted">å¤§äººç¸½æ•¸</div>
                <div class="value" id="totalAdults">â€”</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="kpi p-3">
                <div class="small-muted">å°å­©ç¸½æ•¸</div>
                <div class="value" id="totalKids">â€”</div>
              </div>
            </div>
          </div>

          <div class="card mt-2">
            <div class="card-body">
              <div class="small-muted mb-2">æ¯æ®µäººæ•¸</div>
              <div id="perSegmentCounts" class="d-flex flex-wrap gap-2"></div>
            </div>
          </div>

          <div class="card mt-2">
            <div class="card-body">
              <div class="small-muted mb-2">åå–®</div>
              <div id="participants" class="vstack gap-2"></div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="./config.js"></script>
<script src="./app.js"></script>
<script>
let USER = null;
let CURRENT_EVENT = null;
let CURRENT_SEGMENTS = [];
let CURRENT_REG = null;
let LOADED_REGS = {}; // eventId -> true when registrations loaded once


function renderEvents(events){
  const list = document.getElementById("eventsList");
  list.innerHTML = "";

  // Skeleton state: pass null/undefined to render placeholders
  if (!events){
    for (let i=0; i<6; i++){
      const sk = document.createElement("div");
      sk.className = "list-group-item";
      sk.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div style="width:78%">
            <div class="skeleton" style="height:14px; width:70%;"></div>
            <div class="skeleton mt-2" style="height:12px; width:55%;"></div>
          </div>
          <div class="skeleton" style="height:20px; width:60px; border-radius:999px;"></div>
        </div>
      `;
      list.appendChild(sk);
    }
    return;
  }

  if (!events.length){
    list.innerHTML = `<div class="small-muted">ç›®å‰æ²’æœ‰æ´»å‹•</div>`;
    return;
  }

  events.forEach(ev=>{
    const a = document.createElement("button");
    a.type = "button";
    a.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center";
    a.innerHTML = `
      <div>
        <div class="fw-semibold">${escapeHtml(ev.title)}</div>
        <div class="small-muted">${escapeHtml(ev.description || "")}</div>
      </div>
      <span class="badge text-bg-${ev.status === "OPEN" ? "success" : "secondary"}">${ev.status}</span>
    `;
    a.onclick = ()=> loadEvent(ev.eventId);
    list.appendChild(a);
  });
}

function renderEventHeader(ev){
  document.getElementById("eventTitle").textContent = ev.title;
  document.getElementById("eventDesc").textContent = ev.description || "";
  document.getElementById("eventStatus").innerHTML =
    ev.status === "OPEN"
      ? `<div class="alert alert-success mb-0">ğŸŸ¢ å ±åä¸­</div>`
      : `<div class="alert alert-secondary mb-0">âšª å·²çµå–®</div>`;
}

function renderSegments(segments, selectedSegmentIds){
  const wrap = document.getElementById("segmentsWrap");
  wrap.innerHTML = "";
  if (!segments.length){
    wrap.innerHTML = `<div class="small-muted">æ­¤æ´»å‹•å°šæœªè¨­å®šè¡Œç¨‹åˆ†æ®µ</div>`;
    return;
  }
  segments.forEach(seg=>{
    const checked = selectedSegmentIds.includes(seg.segmentId) ? "checked" : "";
    const time = formatSegmentTime(seg);
    const el = document.createElement("div");
    el.className = "card seg-card";
    el.innerHTML = `
      <div class="card-body">
        <div class="d-flex align-items-start gap-3">
          <div class="form-check mt-1">
            <input class="form-check-input seg-check" type="checkbox" data-segid="${seg.segmentId}" ${checked}>
          </div>
          <div class="flex-grow-1">
            ${segments.length > 1 ? `<div class="small-muted fw-semibold">è¡Œç¨‹ ${seg.order}</div>` : ``}
            <div class="seg-title mt-1">${escapeHtml(seg.location)}</div>
            <div class="seg-meta mt-1">
              ${time ? `<span class="badge text-bg-light border mono">${escapeHtml(time)}</span>` : ""}
</div>
            ${seg.highlights ? `<div class="segment-highlight small-muted mt-2">${escapeHtml(seg.highlights)}</div>` : ""}
          </div>
        </div>
      </div>
    `;
    wrap.appendChild(el);
  });
}

function getSelectedSegmentIds(){
  return $$(".seg-check").filter(x=>x.checked).map(x=>x.dataset.segid);
}

function setAllSegments(value){
  $$(".seg-check").forEach(x=> x.checked = value);
}

function renderCounts(segments, regs){
  const groups = regs.length;
  const adultsTotal = regs.reduce((s,r)=> s + (Number(r.adults)||0), 0);
  const kidsTotal = regs.reduce((s,r)=> s + (Number(r.kids)||0), 0);

  document.getElementById("totalGroups").textContent = String(groups);
  document.getElementById("totalAdults").textContent = String(adultsTotal);
  document.getElementById("totalKids").textContent = String(kidsTotal);

  const counts = {};
  segments.forEach(s=> counts[s.segmentId] = 0);
  regs.forEach(r=>{
    (r.segments || []).forEach(segId=>{
      if (counts[segId] !== undefined) counts[segId] += 1;
    });
  });
  const wrap = document.getElementById("perSegmentCounts");
  wrap.innerHTML = "";
  segments.forEach(s=>{
    const b = document.createElement("span");
    b.className = "badge text-bg-light border";
    b.textContent = `è¡Œç¨‹ ${s.order}: ${counts[s.segmentId] || 0} çµ„`;
    wrap.appendChild(b);
  });
}

function renderParticipants(regs, segments){
  const segMap = {};
  segments.forEach(s=> segMap[s.segmentId] = s.order);
  const wrap = document.getElementById("participants");
  wrap.innerHTML = "";
  if (!regs.length){
    wrap.innerHTML = `<div class="small-muted">é‚„æ²’æœ‰äººå ±å</div>`;
    return;
  }
  regs.forEach(r=>{
    const segOrders = (r.segments || []).map(id=>segMap[id]).filter(Boolean).sort((a,b)=>a-b);
    const el = document.createElement("div");
    el.className = "d-flex justify-content-between align-items-center border rounded-3 p-2 bg-white";
    const people = `å¤§${Number(r.adults)||0}ãƒ»å°${Number(r.kids)||0}`;
    el.innerHTML = `
      <div class="fw-semibold">${escapeHtml(r.displayName || "ï¼ˆæœªå‘½åï¼‰")}</div>
      ${r.childName ? `<div class="small-muted">ğŸ‘¶ ${escapeHtml(r.childName)}</div>` : ``}
      <div class="text-end">
        <div class="small-muted">äººæ•¸ï¼š${people}</div>
        <div class="small-muted">è¡Œç¨‹ï¼š${segOrders.length ? segOrders.join(", ") : "â€”"}</div>
      </div>
    `;
    wrap.appendChild(el);
  });
}

async function refreshStats(){
  if (!CURRENT_EVENT) return;
  const eventId = CURRENT_EVENT.eventId;
  const firstTime = !LOADED_REGS[eventId];

  const sp = document.getElementById("regsSpinner");
  if (firstTime){
    setLoading(true, "è¼‰å…¥å ±ååå–®â€¦");
    await nextFrame();
  }else{
    if (sp) sp.style.display = "inline-block";
  }

  try{
    const data = await apiGet({ action:"listRegistrations", eventId });
    const regs = data.registrations || [];
    renderCounts(CURRENT_SEGMENTS, regs);
    renderParticipants(regs, CURRENT_SEGMENTS);
    LOADED_REGS[eventId] = true;
  }finally{
    if (firstTime) setLoading(false);
    if (sp) sp.style.display = "none";
  }
}

async function loadEvent(eventId){
  if (!isConfigured()){
    toast("è«‹å…ˆåœ¨ config.js å¡«å¥½ API_BASE / LIFF_ID", "error");
    return;
  }
  try{
    const data = await apiGet({ action:"getEvent", eventId, userId: (USER&&USER.userId)?USER.userId:"" });
    CURRENT_EVENT = data.event;
    CURRENT_SEGMENTS = data.segments || [];
    CURRENT_REG = data.registration || null;

    renderEventHeader(CURRENT_EVENT);

    const selected = CURRENT_REG ? (CURRENT_REG.segments || []) : [];
    renderSegments(CURRENT_SEGMENTS, selected);

    document.getElementById("adults").value = CURRENT_REG ? (CURRENT_REG.adults ?? "") : "";
    document.getElementById("kids").value = CURRENT_REG ? (CURRENT_REG.kids ?? "") : "";
    document.getElementById("childName").value = CURRENT_REG ? (CURRENT_REG.childName ?? "") : "";

    const isOpen = CURRENT_EVENT.status === "OPEN";
    document.getElementById("btnAll").disabled = !isOpen;
    document.getElementById("btnNone").disabled = !isOpen;
    document.getElementById("btnSubmit").disabled = !isOpen;
    document.getElementById("btnRefresh").disabled = false;
    document.getElementById("btnShare").disabled = !(USER && USER.liffReady);

    await refreshStats();
  }catch(e){
    console.error(e);
    toast(e.message, "error");
  }
}

async function loadEvents(){
  if (!isConfigured()){
    toast("è«‹å…ˆåœ¨ config.js å¡«å¥½ API_BASE / LIFF_ID", "error");
    return;
  }
  // å…ˆé¡¯ç¤ºéª¨æ¶å±ï¼Œé«”æ„Ÿæ›´å¿«
  renderEvents(null);
  try{
    const data = await apiGet({ action:"listEvents" });
    renderEvents(data.events || []);
  }catch(e){
    toast(e.message, "error");
    renderEvents([]);
  }
}

async function submitRegistration(){
  if (!CURRENT_EVENT) return;
  if (!USER || !USER.userId){
    toast("è«‹ä½¿ç”¨ LINE å…§é–‹å•Ÿï¼ˆLIFFï¼‰æ‰èƒ½å ±åä¸¦é¡¯ç¤ºåå–®", "error");
    return;
  }
  const segments = getSelectedSegmentIds();
  const adults = clampInt(document.getElementById("adults").value, 0, 20);
  const kids = clampInt(document.getElementById("kids").value, 0, 20);
  const childName = document.getElementById("childName").value.trim();

  setLoading(true, "é€å‡ºå ±åâ€¦");
  await nextFrame();
  try{
    await apiPost({
      action:"register",
      eventId: CURRENT_EVENT.eventId,
      userId: USER.userId,
      displayName: USER.displayName,
      adults,
      kids,
      childName,
      segments
    });
    toast("å·²æ›´æ–°å ±å âœ…", "success");
    await loadEvent(CURRENT_EVENT.eventId);
  }finally{
    setLoading(false);
  }
}

async function shareEvent(){
  if (!CURRENT_EVENT) return;
  if (!USER || !USER.liffReady) return;
  const url = window.location.origin + window.location.pathname + "?eventId=" + encodeURIComponent(CURRENT_EVENT.eventId);
  const text = `ğŸ“Œ ${CURRENT_EVENT.title}
${CURRENT_EVENT.description || ""}

é»æ­¤å ±åï¼ˆå¯é¸è¡Œç¨‹åƒåŠ ï¼‰ï¼š
${url}`;

  // shareTargetPicker: å–æ¶ˆåˆ†äº«æ™‚é€šå¸¸æœƒå›å‚³ null/undefined
  const res = await liff.shareTargetPicker([{ type:"text", text }]);
  if (res) toast("å·²é€å‡ºåˆ†äº« âœ…", "success");
  else toast("å·²å–æ¶ˆåˆ†äº«", "info");
}

document.getElementById("btnAll").onclick = ()=> setAllSegments(true);
document.getElementById("btnNone").onclick = ()=> setAllSegments(false);
document.getElementById("btnSubmit").onclick = ()=> submitRegistration().catch(e=>toast(e.message,"error"));
document.getElementById("btnRefresh").onclick = ()=> refreshStats().catch(e=>toast(e.message,"error"));
document.getElementById("btnShare").onclick = ()=> shareEvent().catch(e=>toast("åˆ†äº«å¤±æ•—ï¼š" + (e?.message || ""), "error"));

(async ()=>{
  USER = await initLiffIfAvailable();
  setUserPill(USER);
  await loadEvents();
  const params = new URLSearchParams(window.location.search);
  const eventId = params.get("eventId");
  if (eventId) loadEvent(eventId);
})();
</script>
</body>
</html>
