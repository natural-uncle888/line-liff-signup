<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ç­ç´šæ´»å‹•å ±åï¼ˆLIFFï¼‰</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="./styles.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand" href="./index.html">ğŸ“Œ æ´»å‹•å ±å</a>
    <div class="ms-auto d-flex align-items-center gap-2">
      <div id="userPill"></div>
      <a class="btn btn-sm btn-outline-secondary" href="./admin.html">ç®¡ç†</a>
    </div>
  </div>
</nav>

<div class="container py-3">
  <div id="toast" class="alert alert-info" style="display:none"></div>

  <div class="row g-3">
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-2">æ´»å‹•åˆ—è¡¨</h5>
          <div class="small-muted mb-3">é¸ä¸€å€‹æ´»å‹•é–‹å§‹å ±åï¼ˆå¯é¸æ®µè½ï¼‰</div>
          <div id="eventsList" class="list-group"></div>
          <div class="small-muted mt-3">
            è‹¥ä½ åœ¨ LINE è£¡é–‹å•Ÿï¼Œæœƒè‡ªå‹•å¸¶å…¥å§“åä¸¦é¡¯ç¤ºåå–®ï¼ˆæå‡è·Ÿé¢¨æ„é¡˜ï¼‰ã€‚
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between gap-3">
            <div>
              <h5 class="card-title mb-1" id="eventTitle">è«‹å…ˆé¸æ“‡æ´»å‹•</h5>
              <div class="small-muted" id="eventDesc"></div>
            </div>
            <div class="text-end">
              <button class="btn btn-sm btn-outline-primary" id="btnShare" disabled>åœ¨ LINE åˆ†äº«æ­¤æ´»å‹•</button>
            </div>
          </div>

          <hr/>

          <div id="eventStatus" class="mb-3"></div>

          <div class="d-flex flex-wrap gap-2 mb-3">
            <button class="btn btn-success" id="btnAll" disabled>âœ… å…¨ç¨‹åƒåŠ </button>
            <button class="btn btn-outline-secondary" id="btnNone" disabled>â†©ï¸ å–æ¶ˆå…¨ç¨‹</button>
            <button class="btn btn-primary" id="btnSubmit" disabled>é€å‡º / æ›´æ–°å ±å</button>
          </div>

          <div id="segmentsWrap" class="vstack gap-2"></div>

          <hr class="my-4"/>

          <div class="d-flex align-items-center justify-content-between">
            <h6 class="mb-0">ç›®å‰åƒåŠ ç‹€æ³</h6>
            <button class="btn btn-sm btn-outline-secondary" id="btnRefresh" disabled>é‡æ–°æ•´ç†</button>
          </div>

          <div class="row g-2 mt-1">
            <div class="col-md-4">
              <div class="card">
                <div class="card-body">
                  <div class="small-muted">ç¸½åƒåŠ äººæ•¸ï¼ˆè‡³å°‘ä¸€æ®µï¼‰</div>
                  <div class="fs-3 fw-bold" id="totalPeople">â€”</div>
                </div>
              </div>
            </div>
            <div class="col-md-8">
              <div class="card">
                <div class="card-body">
                  <div class="small-muted mb-2">æ¯æ®µäººæ•¸</div>
                  <div id="perSegmentCounts" class="d-flex flex-wrap gap-2"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="card mt-2">
            <div class="card-body">
              <div class="small-muted mb-2">åå–®ï¼ˆå¯å¢åŠ ã€Œçœ‹åˆ°èª°å»ã€çš„åƒåŠ å‹•æ©Ÿï¼‰</div>
              <div id="participants" class="vstack gap-2"></div>
            </div>
          </div>

          <div class="small-muted mt-3">
            æé†’ï¼šçµå–®å¾Œä»å¯æŸ¥çœ‹åå–®ï¼Œä½†ä¸èƒ½å†æ›´æ–°å ±åã€‚
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="./config.js"></script>
<script src="./app.js"></script>
<script>
let USER = null;
let CURRENT_EVENT = null;
let CURRENT_SEGMENTS = [];
let CURRENT_REG = null;

function setDisabledAll(disabled){
  ["btnAll","btnNone","btnSubmit","btnRefresh","btnShare"].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.disabled = disabled;
  });
}

function renderEvents(events){
  const list = document.getElementById("eventsList");
  list.innerHTML = "";
  if (!events.length){
    list.innerHTML = `<div class="small-muted">ç›®å‰æ²’æœ‰ OPEN æ´»å‹•</div>`;
    return;
  }
  events.forEach(ev=>{
    const a = document.createElement("button");
    a.type = "button";
    a.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center";
    a.innerHTML = `
      <div>
        <div class="fw-semibold">${escapeHtml(ev.title)}</div>
        <div class="small-muted">${escapeHtml(ev.description || "")}</div>
      </div>
      <span class="badge text-bg-${ev.status === "OPEN" ? "success" : "secondary"}">${ev.status}</span>
    `;
    a.onclick = ()=> loadEvent(ev.eventId);
    list.appendChild(a);
  });
}

function renderEventHeader(ev){
  document.getElementById("eventTitle").textContent = ev.title;
  document.getElementById("eventDesc").textContent = ev.description || "";
  const st = ev.status === "OPEN"
    ? `<div class="alert alert-success mb-0">ğŸŸ¢ å ±åä¸­ï¼ˆOPENï¼‰</div>`
    : `<div class="alert alert-secondary mb-0">âšª å·²çµå–®ï¼ˆCLOSEDï¼‰</div>`;
  document.getElementById("eventStatus").innerHTML = st;
}

function renderSegments(segments, selectedSegmentIds){
  const wrap = document.getElementById("segmentsWrap");
  wrap.innerHTML = "";
  if (!segments.length){
    wrap.innerHTML = `<div class="small-muted">æ­¤æ´»å‹•å°šæœªè¨­å®šè¡Œç¨‹åˆ†æ®µ</div>`;
    return;
  }
  segments.forEach(seg=>{
    const checked = selectedSegmentIds.includes(seg.segmentId) ? "checked" : "";
    const time = formatSegmentTime(seg);
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <div class="card-body">
        <div class="d-flex align-items-start gap-3">
          <div class="form-check mt-1">
            <input class="form-check-input seg-check" type="checkbox" id="seg_${seg.segmentId}" data-segid="${seg.segmentId}" ${checked}>
          </div>
          <div class="flex-grow-1">
            <div class="d-flex flex-wrap align-items-center gap-2">
              <div class="fw-semibold">${escapeHtml(seg.location)}</div>
              ${time ? `<span class="badge text-bg-light border mono">${escapeHtml(time)}</span>` : ""}
              <span class="badge text-bg-light border">æ®µè½ ${seg.order}</span>
            </div>
            ${seg.highlights ? `<div class="segment-highlight small-muted mt-2">${escapeHtml(seg.highlights)}</div>` : ""}
          </div>
        </div>
      </div>
    `;
    wrap.appendChild(el);
  });
}

function getSelectedSegmentIds(){
  return $$(".seg-check").filter(x=>x.checked).map(x=>x.dataset.segid);
}

function setAllSegments(value){
  $$(".seg-check").forEach(x=> x.checked = value);
}

function renderCounts(segments, regs){
  // total unique people
  const total = regs.length;
  document.getElementById("totalPeople").textContent = String(total);

  // per segment counts
  const counts = {};
  segments.forEach(s=> counts[s.segmentId] = 0);
  regs.forEach(r=>{
    (r.segments || []).forEach(segId=>{
      if (counts[segId] !== undefined) counts[segId] += 1;
    });
  });
  const wrap = document.getElementById("perSegmentCounts");
  wrap.innerHTML = "";
  segments.forEach(s=>{
    const b = document.createElement("span");
    b.className = "badge text-bg-light border";
    b.textContent = `æ®µè½ ${s.order}: ${counts[s.segmentId] || 0} äºº`;
    wrap.appendChild(b);
  });
}

function renderParticipants(regs, segments){
  const segMap = {};
  segments.forEach(s=> segMap[s.segmentId] = s.order);
  const wrap = document.getElementById("participants");
  wrap.innerHTML = "";
  if (!regs.length){
    wrap.innerHTML = `<div class="small-muted">é‚„æ²’æœ‰äººå ±å</div>`;
    return;
  }
  regs.forEach(r=>{
    const segOrders = (r.segments || []).map(id=>segMap[id]).filter(Boolean).sort((a,b)=>a-b);
    const el = document.createElement("div");
    el.className = "d-flex justify-content-between align-items-center border rounded-3 p-2 bg-white";
    el.innerHTML = `
      <div class="fw-semibold">${escapeHtml(r.displayName || "ï¼ˆæœªå‘½åï¼‰")}</div>
      <div class="small-muted">åƒåŠ æ®µè½ï¼š${segOrders.length ? segOrders.join(", ") : "â€”"}</div>
    `;
    wrap.appendChild(el);
  });
}

async function refreshStats(){
  if (!CURRENT_EVENT) return;
  const data = await apiGet({ action:"listRegistrations", eventId: CURRENT_EVENT.eventId });
  const regs = data.registrations || [];
  renderCounts(CURRENT_SEGMENTS, regs);
  renderParticipants(regs, CURRENT_SEGMENTS);
}

async function loadEvent(eventId){
  if (!isConfigured()){
    toast("è«‹å…ˆåœ¨ config.js å¡«å¥½ API_BASE / LIFF_ID", "error");
    return;
  }
  setDisabledAll(true);
  try{
    const data = await apiGet({ action:"getEvent", eventId });
    CURRENT_EVENT = data.event;
    CURRENT_SEGMENTS = data.segments || [];
    CURRENT_REG = data.registration || null;
    renderEventHeader(CURRENT_EVENT);
    const selected = CURRENT_REG ? (CURRENT_REG.segments || []) : [];
    renderSegments(CURRENT_SEGMENTS, selected);

    // enable buttons
    const isOpen = CURRENT_EVENT.status === "OPEN";
    document.getElementById("btnAll").disabled = !isOpen;
    document.getElementById("btnNone").disabled = !isOpen;
    document.getElementById("btnSubmit").disabled = !isOpen;
    document.getElementById("btnRefresh").disabled = false;
    document.getElementById("btnShare").disabled = !(USER && USER.liffReady);

    await refreshStats();
  }catch(e){
    console.error(e);
    toast(e.message, "error");
  }finally{
    setDisabledAll(false);
    // but respect closed state
    if (CURRENT_EVENT && CURRENT_EVENT.status !== "OPEN"){
      document.getElementById("btnAll").disabled = true;
      document.getElementById("btnNone").disabled = true;
      document.getElementById("btnSubmit").disabled = true;
    }
  }
}

async function loadEvents(){
  if (!isConfigured()){
    toast("è«‹å…ˆåœ¨ config.js å¡«å¥½ API_BASE / LIFF_ID", "error");
    return;
  }
  try{
    const data = await apiGet({ action:"listEvents" });
    renderEvents(data.events || []);
  }catch(e){
    console.error(e);
    toast(e.message, "error");
  }
}

async function submitRegistration(){
  if (!CURRENT_EVENT) return;
  if (!USER || !USER.userId){
    toast("è«‹ä½¿ç”¨ LINE å…§é–‹å•Ÿï¼ˆLIFFï¼‰æ‰èƒ½å ±åä¸¦é¡¯ç¤ºåå–®", "error");
    return;
  }
  const segments = getSelectedSegmentIds();
  try{
    await apiPost({
      action:"register",
      eventId: CURRENT_EVENT.eventId,
      userId: USER.userId,
      displayName: USER.displayName,
      segments
    });
    toast("å·²æ›´æ–°å ±å âœ…", "success");
    await loadEvent(CURRENT_EVENT.eventId);
  }catch(e){
    console.error(e);
    toast(e.message, "error");
  }
}

async function shareEvent(){
  if (!CURRENT_EVENT) return;
  if (!USER || !USER.liffReady) return;
  const url = window.location.origin + window.location.pathname + "?eventId=" + encodeURIComponent(CURRENT_EVENT.eventId);
  const text = `ğŸ“Œ ${CURRENT_EVENT.title}\n${CURRENT_EVENT.description || ""}\n\né»æ­¤å ±åï¼ˆå¯é¸æ®µè½ï¼‰ï¼š\n${url}`;
  try{
    await liff.shareTargetPicker([{ type:"text", text }]);
    toast("å·²é–‹å•Ÿåˆ†äº«", "success");
  }catch(e){
    console.warn(e);
    toast("åˆ†äº«å·²å–æ¶ˆæˆ–å¤±æ•—", "error");
  }
}

document.getElementById("btnAll").onclick = ()=> setAllSegments(true);
document.getElementById("btnNone").onclick = ()=> setAllSegments(false);
document.getElementById("btnSubmit").onclick = submitRegistration;
document.getElementById("btnRefresh").onclick = refreshStats;
document.getElementById("btnShare").onclick = shareEvent;

(async ()=>{
  USER = await initLiffIfAvailable();
  setUserPill(USER);
  await loadEvents();
  const params = new URLSearchParams(window.location.search);
  const eventId = params.get("eventId");
  if (eventId) loadEvent(eventId);
})();
</script>
</body>
</html>
